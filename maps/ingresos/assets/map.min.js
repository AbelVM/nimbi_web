function createDonutChart(e){const t=[],o=Math.round((e.renta_bruta||0)/(e.count||1)),s=[e[fuentes[0]]||0,e[fuentes[1]]||0,e[fuentes[2]]||0,e[fuentes[3]]||0,e[fuentes[4]]||0];let n=0;for(let e=0;e<s.length;e++)t.push(n),n+=s[e];const r=jenks;let a,i;switch(!0){case o<r[0]:a=10,i=25;break;case o<r[1]:a=12,i=30;break;case o<r[2]:a=14,i=35;break;case o<r[3]:a=16,i=40;break;case o<r[4]:a=18,i=45;break;case o<r[5]:a=20,i=50;break;case o<r[6]:a=22,i=55;break;default:a=24,i=60}const c=Math.round(.65*i),l=2*i;let d=`<div><svg width="${l}" height="${l}" viewbox="0 0 ${l} ${l}" text-anchor="middle" style="font: ${a}px sans-serif; display: block">`;for(let e=0;e<s.length;e++)d+=donutSegment(t[e]/n,(t[e]+s[e])/n,i,c,colors[e]);d+=`<circle cx="${i}" cy="${i}" r="${c}" fill="white" />\n    <text dominant-baseline="central" transform="translate(${i}, ${i})">\n      ${o.toLocaleString()}\n    </text>\n    </svg></div>`;const u=document.createElement("div");return u.innerHTML=d,u.firstChild}function donutSegment(e,t,o,s,n){t-e==1&&(t-=1e-5);const r=2*Math.PI*(e-.25),a=2*Math.PI*(t-.25),i=Math.cos(r),c=Math.sin(r),l=Math.cos(a),d=Math.sin(a),u=t-e>.5?1:0;return['<path d="M',o+s*i,o+s*c,"L",o+o*i,o+o*c,"A",o,o,0,u,1,o+o*l,o+o*d,"L",o+s*l,o+s*d,"A",s,s,0,u,0,o+s*i,o+s*c,`" fill="${n}" />`].join(" ")}function shoot(e){const t={sourceLayer:"zcta",filter:["==","periodo",window._y]},o=map.querySourceFeatures("sscc",t),s=o.map((e,t)=>{const o=e.geometry;return{type:"Feature",id:t,properties:e.properties,geometry:o}}),n={type:"FeatureCollection",features:s};window._f=o,map.on("render",updateMarkers),map.getSource("clusters").setData(n),map.redraw()}class YearSelector{constructor(e,t,o){this.layer=e,this.years=t,this.defaultyear=o,this.onDocumentClick=this.onDocumentClick.bind(this),window._y=o}getDefaultPosition(){const e="top-right";return e}onAdd(e){const t='<br><span class="chevron">⌄</span>';return this.map=e,this.controlContainer=document.createElement("div"),this.controlContainer.classList.add("maplibregl-ctrl"),this.controlContainer.classList.add("maplibregl-ctrl-group"),this.yearContainer=document.createElement("div"),this.yearButton=document.createElement("button"),this.yearButton.type="button",this.yearButton.innerHTML=`${this.defaultyear}${t}`,this.yearContainer.classList.add("maplibregl-style-list"),this.years.forEach(e=>{const o=document.createElement("button");o.type="button",o.innerText=e,o.classList.add(`${e}`),o.addEventListener("click",o=>{const s=o.srcElement;if(s.classList.contains("active"))return;this.yearContainer.style.display="none",this.yearButton.style.display="block";const n=this.yearContainer.getElementsByClassName("active");for(;n[0];)n[0].classList.remove("active");s.classList.add("active"),this.yearButton.innerHTML=`${e}${t}`,window._y=e,document.querySelector("#year").innerText=window._y,shoot()}),e===this.defaultyear&&o.classList.add("active"),this.yearContainer.appendChild(o)}),this.yearButton.classList.add("maplibregl-ctrl-icon"),this.yearButton.classList.add("maplibregl-style-switcher"),this.yearButton.addEventListener("click",()=>{this.yearButton.style.display="none",this.yearContainer.style.display="block"}),document.addEventListener("click",this.onDocumentClick),this.controlContainer.appendChild(this.yearButton),this.controlContainer.appendChild(this.yearContainer),this.controlContainer}onRemove(){this.controlContainer&&this.controlContainer.parentNode&&this.map&&this.styleButton&&(this.styleButton.removeEventListener("click",this.onDocumentClick),this.controlContainer.parentNode.removeChild(this.controlContainer),document.removeEventListener("click",this.onDocumentClick),this.map=void 0)}onDocumentClick(e){this.controlContainer&&!this.controlContainer.contains(e.target)&&this.mapStyleContainer&&this.styleButton&&(this.mapStyleContainer.y.display="none",this.styleButton.y.display="block")}}const fuentes=["salario","pensiones","desempleo","otras_prestaciones","otros"],desc=["Salarios","Pensiones","Prestaciones por desempleo","Otras prestaciones","Otros (rentas, actividades económicas)"],colors=["#ff6e61","#707eff","#f2e03a","#ff3d7e","#4ce1d7"],jenks=[4528,11092,14568,18681,24645,34813,51091],ntiles=[9288,10998,12483,14069,16108,19378,51091];String.prototype.hashCode=function(){var e,t,o=0;if(0===this.length)return o;for(e=0;e<this.length;e++)t=this.charCodeAt(e),o=(o<<5)-o+t,o|=0;return o};const markers={};let markersOnScreen={};const updateMarkers=async()=>{const e={},t=map.queryRenderedFeatures({layers:["grupos"],filter:["!=",["coalesce",["get","renta_bruta"],0],0]});if(0==t.length)return map.once("render",updateMarkers),!1;for(let o=0;o<t.length;o++){const s=t[o].geometry.coordinates,n=t[o].properties,r=-1*JSON.stringify(n).hashCode();let a=markers[r];if(!a){const e=createDonutChart(n);a=markers[r]=new maplibregl.Marker({element:e}).setLngLat(s)}e[r]=a,markersOnScreen[r]||a.addTo(map)}for(let t in markersOnScreen)e[t]||markersOnScreen[t].remove();markersOnScreen=e},protocol=new pmtiles.Protocol;maplibregl.addProtocol("pmtiles",protocol.tile);const PMTILES_URL=new URL("./assets/fuentes_ingresos.pmtiles",window.location.href).toString(),p=new pmtiles.PMTiles(PMTILES_URL);protocol.add(p),p.getHeader().then(e=>{const t=document.querySelector(".legend");desc.forEach((e,o)=>{const s=document.createElement("div");s.innerHTML=`<span style="background-color:${colors[o]}"></span>${e}`,t.appendChild(s)});const o=new maplibregl.Map({container:"map",style:"https://api.maptiler.com/maps/dataviz/style.json?key=14pGsuZUnf0Y98AevmDA",zoom:5.25,center:[-6.933105468750682,35.85721541019794],dragRotate:!1});o.addControl(new maplibregl.NavigationControl({showCompass:!1}),"bottom-right"),o.on("load",async()=>{o.addSource("sscc",{type:"vector",url:`pmtiles://${PMTILES_URL}`}),o.addLayer({id:"fuentes",type:"circle",source:"sscc","source-layer":"zcta",paint:{"circle-opacity":0}}),o.addSource("clusters",{type:"geojson",data:{type:"FeatureCollection",features:[]},attribution:'Elaboración propia con datos extraídos del <a href="https://www.ine.es">INE</a>',cluster:!0,clusterRadius:140,clusterProperties:{sscc:["max",["coalesce",["to-number",["get","sscc"]],0]],count:["+",1],periodo:["max",["coalesce",["get","periodo"],0]],renta_bruta:["+",["coalesce",["get","renta_bruta"],0]],salario:["+",["coalesce",["get","salario"],0]],pensiones:["+",["coalesce",["get","pensiones"],0]],desempleo:["+",["coalesce",["get","desempleo"],0]],otras_prestaciones:["+",["coalesce",["get","otras_prestaciones"],0]],otros:["+",["coalesce",["get","otros"],0]]}}),o.addLayer({id:"grupos",type:"circle",source:"clusters",paint:{"circle-opacity":0}}),o.addControl(new YearSelector("fuentes",[2015,2016,2017,2018,2019,2020,2021,2022],2022)),o.on("sourcedata",e=>{"sscc"===e.sourceId&&e.isSourceLoaded&&shoot()}),o.getSource("sscc").loaded()&&(o.on("move",shoot),o.on("moveend",shoot),o.on("idle",shoot),o.on("render",updateMarkers),o.getSource("sscc").fire("sourcedata"))}),window.map=o});